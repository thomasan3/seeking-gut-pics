<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Upload Photo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; text-align:center; padding:30px; background:#111; color:#fff; }
    img { max-width: 90%; margin-top: 15px; border-radius: 10px; display:none; }
    button { padding: 12px 20px; font-size: 16px; border:none; border-radius: 8px; cursor:pointer; margin:8px; }
    .upload-btn { background:#4CAF50; color:#fff; }
    .retake-btn { background:#f44336; color:#fff; }
    #status { margin-top: 16px; font-weight:bold; white-space:pre-wrap; }
  </style>
</head>

<body>
  <h1>Upload Photo</h1>
  <input type="file" id="fileInput" accept="image/*" capture="environment" />
  <br />
  <img id="preview" />
  <br />
  <button class="upload-btn" id="uploadBtn">Upload</button>
  <button class="retake-btn" id="retakeBtn">Retake</button>
  <div id="status"></div>

  <!-- IMPORTANT: THIS MUST BE type="module" -->
  <script type="module">
const firebaseConfig = {
  apiKey: "AIzaSyAGBk_qMddYXMl24Em8J_IGb6GxQxQeBa4",
  authDomain: "seeking-gut.firebaseapp.com",
  databaseURL: "https://seeking-gut-default-rtdb.firebaseio.com",
  projectId: "seeking-gut",
  storageBucket: "seeking-gut.firebasestorage.app",
  messagingSenderId: "934480362973",
  appId: "1:934480362973:web:5a29fdb02e794f88e88a34",
  measurementId: "G-CXXNYWC665"
};

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getStorage, ref, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);

    const fileInput = document.getElementById("fileInput");
    const preview = document.getElementById("preview");
    const statusEl = document.getElementById("status");
    const uploadBtn = document.getElementById("uploadBtn");
    const retakeBtn = document.getElementById("retakeBtn");

    let selectedFile = null;
    let lastUploadTime = 0;
    const COOLDOWN_MS = 10000;

    const STORAGE_PATH = "uploads/latest.png";

    fileInput.addEventListener("change", (e) => {
      selectedFile = e.target.files?.[0] || null;
      if (!selectedFile) return;

      const reader = new FileReader();
      reader.onload = (evt) => {
        preview.src = evt.target.result;
        preview.style.display = "block";
        statusEl.textContent = "";
      };
      reader.readAsDataURL(selectedFile);
    });

    function retake() {
      fileInput.value = "";
      selectedFile = null;
      preview.src = "";
      preview.style.display = "none";
      statusEl.textContent = "";
    }

    function uploadImage() {
      const now = Date.now();
      if (now - lastUploadTime < COOLDOWN_MS) {
        const waitSec = Math.ceil((COOLDOWN_MS - (now - lastUploadTime)) / 1000);
        statusEl.textContent = `Please wait ${waitSec}s before uploading again.`;
        return;
      }

      if (!selectedFile) {
        statusEl.textContent = "No image selected.";
        return;
      }

      const fileRef = ref(storage, STORAGE_PATH);
      statusEl.textContent = "Starting upload...";
      uploadBtn.disabled = true;

      const task = uploadBytesResumable(fileRef, selectedFile);

      task.on("state_changed",
        (snap) => {
          const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
          statusEl.textContent = `Uploading... ${pct}%`;
        },
        (err) => {
          console.error(err);
          statusEl.textContent = `Upload failed: ${err.message}`;
          uploadBtn.disabled = false;
        },
        () => {
          lastUploadTime = Date.now();
          statusEl.textContent = "Upload successful âœ…";
          uploadBtn.disabled = false;
        }
      );
    }

    uploadBtn.addEventListener("click", uploadImage);
    retakeBtn.addEventListener("click", retake);
  </script>
</body>
</html>
